#!/bin/bash

ZTD_SERVER_IP="{{hostvars[inventory_hostname]['ansible_default_ipv4']['address']}}"
CGI_HOSTNAME_SCRIPT=/cgi-bin/catch_hostnames.sh
HOSTNAMES=hostnames.dyn

POSTSCRIPT_FILE=post_script.sh
TMP=/tmp/
HOME=/home
ZTD_LOGFILE=ztd.log
LOG=$TMP$ZTD_LOGFILE
CURL=`type -tP curl`

IMG_FILE="http://$ZTD_SERVER_IP/{{ztd_dir}}/{{os10_images_dir}}/{{item.binary}}"
CLI_CONFIG_FILE="http://$ZTD_SERVER_IP/{{ztd_dir}}/{{cli_conf_path}}/cli_config"

POST_SCRIPT_FILE="http://$ZTD_SERVER_IP/{{ztd_dir}}/${{post_install_scripts_dir}}/$POSTSCRIPT_FILE"

## Execute server side script that will fetch hostnames and mac mapping
$CURL http://$ZTD_SERVER_IP/{{ztd_dir}}/$CGI_HOSTNAME_SCRIPT

echo "Request server side hostname mapping preperation :  http://$ZTD_SERVER_IP/{{ztd_dir}}/$CGI_HOSTNAME_SCRIPT" >> $LOG

## Download the file with hostname to mac mapping
$CURL -o $HOME/$HOSTNAMES http://$ZTD_SERVER_IP/{{ztd_dir}}/$HOSTNAMES

echo "Retreived $HOSTNAMES from server and saved to $HOME/$HOSTNAMES" >> $LOG

################### DO NOT MODIFY THE LINES BELOW ##################
sudo os10_ztd_start.sh "$IMG_FILE" "$CLI_CONFIG_FILE" "$POST_SCRIPT_FILE"
############################# **END** #################################
