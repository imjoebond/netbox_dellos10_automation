- name: Infrastructure Services [ZTD server]
  hosts: device_roles_leaf
  gather_facts: false

  vars:
    netbox_url: "{{ lookup('env', 'NETBOX_API') }}"
    netbox_token: "{{ lookup('env', 'NETBOX_TOKEN') }}"
  tasks:
  - name: Show version
    shell:
      cmd: "show version | grep Software | awk '{print $NF}'"
    register: version_info
  - name: format variables
    set_fact:
      fmt_version_info: "{{ ((version_info.stdout | lower) | replace('.','-')) }}" #netbox is converting periods to dashes so I need to convert version info into the same format.
      platform: "{{ hostvars[inventory_hostname]['platforms'][0] }}"

  - name: define file
    delegate_to: local
    stat:
      path: /tmp/switch_audit.csv
    register: audit_file

  - name: create local file if it doesn't exist
    delegate_to: local
    shell:
      cmd: "echo 'hostname,running_version,netbox_version' > /tmp/switch_audit.csv"
    when: audit_file.stat.exists

  - name: write switch data to audit file
    delegate_to: local
    shell:
      cmd: "echo '{{ inventory_hostname }},{{ fmt_version_info }}, {{ platform }}' >> /tmp/switch_audit.csv"
